name: 'Setup leap-c environment'
description: 'Sets up python, acados, and leap-c dependencies'
inputs:
  python-version:
    description: 'Python version to use'
    required: true
    default: '3.11'

runs:
  using: 'composite'
  steps:
    - name: Download acados artifacts (build, lib, include) into acados repository
      uses: actions/download-artifact@v4
      with:
        path: ${{github.workspace}}/leap_c/external/acados
        repository: acados/acados
        github-token: ${{ github.token }}
        run-id: 19819186543

    - name: Rename artifact directories
      working-directory: ${{github.workspace}}/leap_c/external/acados
      shell: bash
      run: for dir in *-build-*; do mv "$dir" "${dir%%-build-*}"; done

    - name: Install Tera
      working-directory: ${{github.workspace}}/leap_c/external/acados
      shell: bash
      run: |
        .github/linux/install_tera.sh

    - name: Export Paths
      working-directory: ${{github.workspace}}
      shell: bash
      run: |
        echo "ACADOS_SOURCE_DIR=${{github.workspace}}/leap_c/external/acados" >> $GITHUB_ENV
        echo "ACADOS_INSTALL_DIR=${{github.workspace}}/leap_c/external/acados" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=${{github.workspace}}/leap_c/external/acados/lib" >> $GITHUB_ENV

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-py${{ inputs.python-version }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-py${{ inputs.python-version }}-pip-

    - name: Install Python interface
      working-directory: ${{github.workspace}}/leap_c/external/acados
      shell: bash
      run: |
        pip install --upgrade pip
        pip install interfaces/acados_template

    - name: Install leap_c
      working-directory: ${{github.workspace}}/leap_c
      shell: bash
      run: |
        pip install -e .[test,hvac]
        pip install torch --extra-index-url https://download.pytorch.org/whl/cpu
